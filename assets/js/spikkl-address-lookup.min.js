jQuery(function(t){if("undefined"==typeof spikkl_params)return!1;const e=new RegExp("^[1-9][0-9]{3}\\s*(?!sa|sd|ss)[a-z]{2}$","i"),s=new RegExp("^[0-9]{1,5}$"),i=new RegExp("^(?:[a-z])?(?:\\s?[a-z0-9]{1,4})?$","i"),r=function(e){this.cache={},this.xhr=null,this.lookupTimeout=null,this.prefix=e.prefix,this.$countryField=t(e.country+"_field"),this.$stateField=t(e.state+"_field"),this.$cityField=t(e.city+"_field"),this.$streetField=t(e.street+"_field"),this.$postcodeField=t(e.postcode+"_field"),this.$streetNumberField=t(e.street_number+"_field"),this.$streetNumberSuffixField=t(e.street_number_suffix+"_field"),this.$country=this.$countryField.find(":input"),this.$state=this.$stateField.find(":input"),this.$city=this.$cityField.find(":input"),this.$street=this.$streetField.find(":input"),this.$postcode=this.$postcodeField.find(":input"),this.$streetNumber=this.$streetNumberField.find(":input"),this.$streetNumberSuffix=this.$streetNumberSuffixField.find(":input"),this.setHelperElements(),this.$country.on("change",()=>{let t=this.getSelectedCountryCode();this.reorderFields(t),this.listen(t)}),this.$country.trigger("change")};r.prototype.listen=function(e){const s=[this.$postcode,this.$streetNumber,this.$streetNumberSuffix];this.isCountryEligibleForLookup(e)?(this.$postcode.on("keyup blur",this.debounce(this.validatePostcode,250)),this.$streetNumber.on("keyup blur",this.debounce(this.validateStreetNumber,250)),this.$streetNumberSuffix.on("keyup blur",this.debounce(this.validateStreetNumberSuffix,250)),t.each(s,(e,s)=>{t(s).on("keyup",this.debounce(this.performLookup,450))}),this.applyFieldsLock()):(t.each(s,(t,e)=>{e.off("keyup")}),this.hardResetFields(),this.releaseFieldsLock())},r.prototype.applyFieldsLock=function(){this.$postcode.attr("autocomplete","off"),this.$postcode.attr("maxlength",7),this.$street.attr("readonly",!0),this.$city.attr("readonly",!0),this.$state.attr("readonly",!0),this.$stateField.addClass("spikkl-hidden")},r.prototype.releaseFieldsLock=function(){this.$postcode.removeAttr("autocomplete"),this.$postcode.removeAttr("maxlength"),this.$street.removeAttr("readonly"),this.$city.removeAttr("readonly"),this.$state.removeAttr("readonly"),this.$stateField.removeClass("spikkl-hidden")},r.prototype.softResetFields=function(){this.$street.val(""),this.$city.val(""),this.$state.val("").trigger("change"),void 0!==this.$spinner&&this.stopLoading()},r.prototype.hardResetFields=function(){this.$postcode.val(""),this.$streetNumber.val(""),this.$streetNumberSuffix.val(""),void 0!==this.$message&&this.$message.hide(),this.softResetFields()},r.prototype.debounce=function(t,e=450){let s;const i=this;return function(){clearTimeout(s),s=setTimeout(function(){s=null,t.apply(i)},e)}},r.prototype.performLookup=function(){if(!this.isValidPostcode()||!this.isValidStreetNumber()||!this.isValidStreetNumberSuffix())return void this.softResetFields();const t=this.$postcode.val(),e=this.$streetNumber.val(),s=this.$streetNumberSuffix.val();this.startLoading(),this.$message.hide();const i={action:spikkl_params.action,postal_code:encodeURIComponent(t),street_number:encodeURIComponent(e),street_number_suffix:encodeURIComponent(s)};this.cachedGet(i)},r.prototype.cachedGet=function(e){const s=spikkl_params.url+JSON.stringify(Object.values(e));this.xhr&&this.xhr.abort(),this.cache.hasOwnProperty(s)?this.fillFields(this.cache[s]):this.xhr=t.ajax({crossDomain:!0,type:"GET",dataType:"json",timeout:5e3,url:spikkl_params.url,data:e,success:(t,e)=>{if(!t||"success"!==e)return this.fillFields({status:"failed",status_code:"UNAVAILABLE"}),void this.releaseFieldsLock();this.cache[s]=t,this.fillFields(t)}})},r.prototype.startLoading=function(){this.$spinner.show(),this.$postcode.attr("disabled",!0),this.$streetNumber.attr("disabled",!0),this.$streetNumberSuffix.attr("disabled",!0)},r.prototype.stopLoading=function(){this.$spinner.hide(),this.$postcode.attr("disabled",!1),this.$streetNumber.attr("disabled",!1),this.$streetNumberSuffix.attr("disabled",!1)},r.prototype.fillFields=function(t){if(this.stopLoading(),"ok"===t.status&&t.results.length>=1)this.$postcode.val(t.results[0].postal_code),this.$streetNumber.val(t.results[0].street_number),this.$streetNumberSuffix.val(t.results[0].street_number_suffix),this.$street.val(t.results[0].street_name),this.$city.val(t.results[0].city),this.$state.val(t.results[0].administrative_areas[0].abbreviation).trigger("change");else{let e;"ZERO_RESULTS"===t.status_code&&(e=spikkl_params.errors.invalid_address),"INVALID_REQUEST"===t.status_code&&(e=spikkl_params.errors.invalid_postal_code_or_street_number),"UNAVAILABLE"!==t.status_code&&"ACCESS_RESTRICTED"!==t.status_code||(e=spikkl_params.errors.unknown_error,this.releaseFieldsLock()),this.softResetFields(),this.$message.empty().append("<li>"+e+"</li>"),this.$message.show()}},r.prototype.validatePostcode=function(){const t=this.$postcode.val();return null!==t&&""!==t&&(e.test(t)?this.$postcodeField.removeClass("woocommerce-invalid"):this.$postcodeField.addClass("woocommerce-invalid"),!1)},r.prototype.validateStreetNumber=function(){const t=this.$streetNumber.val();return null!==t&&""!==t&&(!!s.test(t)||(this.$message.empty().append("<li>"+spikkl_params.errors.invalid_street_number+"</li>"),this.$message.show(),!1))},r.prototype.validateStreetNumberSuffix=function(){const t=this.$streetNumberSuffix.val();return i.test(t)?(this.$streetNumberSuffixField.removeClass("woocommerce-invalid"),!0):(this.$streetNumberSuffixField.addClass("woocommerce-invalid"),!1)},r.prototype.isValidPostcode=function(){const t=this.$postcode.val();return null!==t&&""!==t&&e.test(t)},r.prototype.isValidStreetNumber=function(){const t=this.$streetNumber.val();return null!==t&&""!==t&&s.test(t)},r.prototype.isValidStreetNumberSuffix=function(){const t=this.$streetNumberSuffix.val();return i.test(t)},r.prototype.setHelperElements=function(){this.$spinner=t("<div>",{id:"spikkl-"+this.prefix+"-spinner",class:"spikkl-loader",style:"display:none;"}),this.$message=t("<ul>",{id:"spikkl-"+this.prefix+"-message",class:"woocommerce-error",style:"display:none;"}),this.$postcode.after(this.$spinner),this.$postcode.before(this.$message)},r.prototype.reorderFields=function(t){this.isCountryEligibleForLookup(t)?(this.$streetNumberField.show(),this.$streetNumberSuffixField.show()):(this.$streetNumberField.hide(),this.$streetNumberSuffixField.hide())},r.prototype.getSelectedCountryCode=function(){return this.$country.val().trim()},r.prototype.isCountryEligibleForLookup=function(t){return t=t||this.getSelectedCountryCode(),spikkl_params.supported_countries.indexOf(t)>=0},t(document.body).bind("wc_address_i18n_ready",function(){"undefined"!=typeof spikkl_billing_fields&&new r(spikkl_billing_fields),"undefined"!=typeof spikkl_shipping_fields&&new r(spikkl_shipping_fields)})});